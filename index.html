<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Relat칩rio Ordem de Produ칞칚o</title>

<style>
@page { size: A4; margin: 12mm; }

body {
    font-family: Arial, sans-serif;
    font-size: 10px;
    margin: 0;
}

.botao-container {
    text-align: right;
    margin-bottom: 10px;
}

.botao {
    padding: 6px 12px;
    font-size: 11px;
    cursor: pointer;
    border: 1px solid #000;
    background-color: #f2f2f2;
}

.titulo {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #000;
    padding: 4px;
    text-align: center;
}
</style>
</head>

<body>

<div class="botao-container">
    <button class="botao" onclick="salvarEFechar()">Salvar e Fechar</button>
</div>

<div class="titulo">
    ORDEM DE PRODU칂츾O
</div>

<div id="conteudo"></div>

<script>

// 游댳 abre como popup se n칚o for
if (window.opener == null) {
    window.open(window.location.href, "Relatorio",
        "width=1100,height=850,toolbar=no,menubar=no,scrollbars=yes,resizable=yes");
    window.close();
}

// 游댳 bloqueia sa칤da
window.onbeforeunload = function () {
    return "Voc칡 precisa salvar antes de sair.";
};

// 游댳 pega dados do Power Apps
const params = new URLSearchParams(window.location.search);
const dadosString = params.get("dados");

if (dadosString) {

    const dados = JSON.parse(decodeURIComponent(dadosString));

    let html = "<table>";
    html += `
        <tr>
            <th>C칩digo</th>
            <th>Complemento</th>
            <th>Qtd F칩rmula</th>
            <th>Toler칙ncia</th>
        </tr>
    `;

    dados.forEach(linha => {

        html += `
            <tr>
                <td>${linha.Codigo ?? ""}</td>
                <td>${linha.Complemento ?? ""}</td>
                <td>${linha.QtdFormula ?? ""}</td>
                <td>${linha.Tolerancia ?? ""}</td>
            </tr>
        `;
    });

    html += "</table>";

    document.getElementById("conteudo").innerHTML = html;
}

// 游댳 salvar e fechar
function salvarEFechar() {

    const conteudo = document.documentElement.outerHTML;
    const blob = new Blob([conteudo], { type: "text/html" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "Relatorio_OP.html";
    a.click();

    URL.revokeObjectURL(url);

    window.onbeforeunload = null;
    window.close();
}

</script>

</body>
</html>
